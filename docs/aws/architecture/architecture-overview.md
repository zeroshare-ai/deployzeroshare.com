# ZeroShare Gateway - Architecture Overview

## System Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ZEROSHARE GATEWAY ARCHITECTURE                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   DEVELOPER WORKSTATIONS                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                        │
│   │   VS Code   │  │   Cursor    │  │  JetBrains  │                        │
│   │  + Copilot  │  │    IDE      │  │  + AI Asst  │                        │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                        │
│          │                │                │                                 │
│          └────────────────┼────────────────┘                                │
│                           │                                                  │
│                           ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    ZEROSHARE GATEWAY                                 │  │
│   │  ┌─────────────────────────────────────────────────────────────┐   │  │
│   │  │                    INGRESS LAYER                             │   │  │
│   │  │  • TLS Termination (ALB)                                     │   │  │
│   │  │  • Rate Limiting                                             │   │  │
│   │  │  • Authentication                                            │   │  │
│   │  └─────────────────────────────────────────────────────────────┘   │  │
│   │                              │                                      │  │
│   │  ┌─────────────────────────────────────────────────────────────┐   │  │
│   │  │                   PROCESSING LAYER                           │   │  │
│   │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │  │
│   │  │  │     PII     │  │   Secrets   │  │   Custom    │         │   │  │
│   │  │  │  Detection  │  │  Detection  │  │   Rules     │         │   │  │
│   │  │  │  (Presidio) │  │  (Patterns) │  │  (Regex)    │         │   │  │
│   │  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │  │
│   │  │                              │                               │   │  │
│   │  │  ┌─────────────────────────────────────────────────────┐   │   │  │
│   │  │  │              REDACTION ENGINE                        │   │   │  │
│   │  │  │  • Pattern Matching                                  │   │   │  │
│   │  │  │  • Token Replacement                                 │   │   │  │
│   │  │  │  • Audit Logging                                     │   │   │  │
│   │  │  └─────────────────────────────────────────────────────┘   │   │  │
│   │  └─────────────────────────────────────────────────────────────┘   │  │
│   │                              │                                      │  │
│   │  ┌─────────────────────────────────────────────────────────────┐   │  │
│   │  │                    ROUTING LAYER                             │   │  │
│   │  │  • AI Backend Selection                                      │   │  │
│   │  │  • Load Balancing                                            │   │  │
│   │  │  • Retry Logic                                               │   │  │
│   │  └─────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                           │                                                  │
│                           ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      AI PROVIDERS                                    │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │  │
│   │  │   Amazon    │  │    Azure    │  │   OpenAI    │                 │  │
│   │  │   Bedrock   │  │   OpenAI    │  │    API      │                 │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘                 │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

### Core Components

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENT DIAGRAM                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        GATEWAY SERVICE                                 │ │
│  │                                                                        │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐               │ │
│  │  │   FastAPI   │    │  Detection  │    │   Router    │               │ │
│  │  │   Server    │───▶│   Engine    │───▶│   Service   │               │ │
│  │  │             │    │             │    │             │               │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘               │ │
│  │         │                  │                  │                       │ │
│  │         ▼                  ▼                  ▼                       │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐               │ │
│  │  │    Auth     │    │   Presidio  │    │  LiteLLM    │               │ │
│  │  │  Middleware │    │    NLP      │    │   Client    │               │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘               │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                       DASHBOARD SERVICE                                │ │
│  │                                                                        │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐               │ │
│  │  │  Streamlit  │    │   Metrics   │    │    Admin    │               │ │
│  │  │     UI      │    │  Collector  │    │   Console   │               │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘               │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Detection Engine Architecture

```python
# Detection Engine Components

class DetectionEngine:
    """
    Multi-layer detection engine for PII and secrets.
    """
    
    def __init__(self):
        # Layer 1: Presidio NLP (PII)
        self.presidio_analyzer = PresidioAnalyzer()
        
        # Layer 2: Pattern Matching (Secrets)
        self.secret_patterns = SecretPatternMatcher()
        
        # Layer 3: Custom Rules
        self.custom_rules = CustomRuleEngine()
        
        # Layer 4: ML-based detection (optional)
        self.ml_detector = MLDetector() if ML_ENABLED else None
    
    async def detect(self, text: str, config: DetectionConfig) -> DetectionResult:
        """
        Run all detection layers and aggregate results.
        """
        results = []
        
        # Parallel detection
        tasks = [
            self.presidio_analyzer.analyze(text),
            self.secret_patterns.scan(text),
            self.custom_rules.evaluate(text, config.custom_patterns)
        ]
        
        if self.ml_detector:
            tasks.append(self.ml_detector.predict(text))
        
        layer_results = await asyncio.gather(*tasks)
        
        # Merge and deduplicate
        return self._merge_results(layer_results)
```

---

## AWS Infrastructure Architecture

### Production Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AWS PRODUCTION ARCHITECTURE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         AWS REGION (us-east-1)                       │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                          VPC                                   │ │   │
│  │  │                                                                │ │   │
│  │  │  PUBLIC SUBNETS                                               │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │ │ │   │
│  │  │  │  │   ALB   │  │   NAT   │  │   NAT   │                 │ │ │   │
│  │  │  │  │  Node   │  │   GW    │  │   GW    │                 │ │ │   │
│  │  │  │  │  (AZ-a) │  │  (AZ-a) │  │  (AZ-b) │                 │ │ │   │
│  │  │  │  └─────────┘  └─────────┘  └─────────┘                 │ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  │                                                                │ │   │
│  │  │  PRIVATE SUBNETS                                              │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │  ┌─────────────────┐  ┌─────────────────┐              │ │ │   │
│  │  │  │  │   ECS Cluster   │  │   ECS Cluster   │              │ │ │   │
│  │  │  │  │                 │  │                 │              │ │ │   │
│  │  │  │  │  ┌───────────┐  │  │  ┌───────────┐  │              │ │ │   │
│  │  │  │  │  │  Gateway  │  │  │  │  Gateway  │  │              │ │ │   │
│  │  │  │  │  │   Task    │  │  │  │   Task    │  │              │ │ │   │
│  │  │  │  │  └───────────┘  │  │  └───────────┘  │              │ │ │   │
│  │  │  │  │  ┌───────────┐  │  │  ┌───────────┐  │              │ │ │   │
│  │  │  │  │  │ Dashboard │  │  │  │ Dashboard │  │              │ │ │   │
│  │  │  │  │  │   Task    │  │  │  │   Task    │  │              │ │ │   │
│  │  │  │  │  └───────────┘  │  │  └───────────┘  │              │ │ │   │
│  │  │  │  │     (AZ-a)      │  │     (AZ-b)      │              │ │ │   │
│  │  │  │  └─────────────────┘  └─────────────────┘              │ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  │                                                                │ │   │
│  │  │  VPC ENDPOINTS                                                │ │   │
│  │  │  ┌──────────────────────────────────────────────────────┐   │ │   │
│  │  │  │  ECR  │  Secrets Manager  │  CloudWatch  │  Bedrock  │   │ │   │
│  │  │  └──────────────────────────────────────────────────────┘   │ │   │
│  │  │                                                                │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                      │   │
│  │  SUPPORTING SERVICES                                                 │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │                                                               │  │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │   │
│  │  │  │   Secrets   │  │ CloudWatch  │  │     ECR     │          │  │   │
│  │  │  │   Manager   │  │    Logs     │  │  Registry   │          │  │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │  │   │
│  │  │                                                               │  │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │   │
│  │  │  │     KMS     │  │ CloudTrail  │  │   Amazon    │          │  │   │
│  │  │  │             │  │             │  │   Bedrock   │          │  │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │  │   │
│  │  │                                                               │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

### Request Processing Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           REQUEST FLOW                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. INGRESS                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Client Request                                                      │   │
│  │       │                                                              │   │
│  │       ▼                                                              │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│  │  │     ALB     │───▶│    Rate     │───▶│    Auth     │             │   │
│  │  │  (TLS Term) │    │   Limiter   │    │  Validate   │             │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│  2. DETECTION                │                                               │
│  ┌───────────────────────────▼─────────────────────────────────────────┐   │
│  │                              │                                       │   │
│  │       ┌──────────────────────┼──────────────────────┐               │   │
│  │       │                      │                      │               │   │
│  │       ▼                      ▼                      ▼               │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│  │  │     PII     │    │   Secrets   │    │   Custom    │             │   │
│  │  │  Detection  │    │  Detection  │    │    Rules    │             │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘             │   │
│  │       │                      │                      │               │   │
│  │       └──────────────────────┼──────────────────────┘               │   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │                    ┌─────────────────┐                              │   │
│  │                    │  Merge Results  │                              │   │
│  │                    └─────────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│  3. REDACTION                │                                               │
│  ┌───────────────────────────▼─────────────────────────────────────────┐   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │                    ┌─────────────────┐                              │   │
│  │                    │    Redaction    │                              │   │
│  │                    │     Engine      │                              │   │
│  │                    └─────────────────┘                              │   │
│  │                              │                                       │   │
│  │           ┌──────────────────┼──────────────────┐                   │   │
│  │           │                  │                  │                   │   │
│  │           ▼                  ▼                  ▼                   │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│  │  │   Replace   │    │    Hash     │    │    Audit    │             │   │
│  │  │   Tokens    │    │   Values    │    │     Log     │             │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│  4. ROUTING                  │                                               │
│  ┌───────────────────────────▼─────────────────────────────────────────┐   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │                    ┌─────────────────┐                              │   │
│  │                    │  Select Backend │                              │   │
│  │                    └─────────────────┘                              │   │
│  │                              │                                       │   │
│  │       ┌──────────────────────┼──────────────────────┐               │   │
│  │       │                      │                      │               │   │
│  │       ▼                      ▼                      ▼               │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│  │  │   Amazon    │    │    Azure    │    │   OpenAI    │             │   │
│  │  │   Bedrock   │    │   OpenAI    │    │    API      │             │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│  5. RESPONSE                 │                                               │
│  ┌───────────────────────────▼─────────────────────────────────────────┐   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │                    ┌─────────────────┐                              │   │
│  │                    │ Return Response │                              │   │
│  │                    │   to Client     │                              │   │
│  │                    └─────────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Scalability Architecture

### Horizontal Scaling

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SCALING ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  LOAD BALANCING                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Application Load Balancer                       │   │
│  │                                                                      │   │
│  │  • Distributes across all healthy targets                           │   │
│  │  • Health checks every 30 seconds                                   │   │
│  │  • Connection draining enabled                                      │   │
│  │  • Sticky sessions disabled (stateless)                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│                              ▼                                               │
│  AUTO SCALING                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  Scaling Policy:                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  Target Tracking: CPU 70%                                    │   │   │
│  │  │  Scale Out: Add 2 tasks when threshold exceeded              │   │   │
│  │  │  Scale In: Remove 1 task when below threshold                │   │   │
│  │  │  Cooldown: 60s out, 300s in                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  Capacity:                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  Minimum: 2 tasks (high availability)                        │   │   │
│  │  │  Desired: 2-4 tasks (normal load)                            │   │   │
│  │  │  Maximum: 20 tasks (peak capacity)                           │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  SCALING METRICS                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  Primary:    CPUUtilization > 70%                                   │   │
│  │  Secondary:  RequestCountPerTarget > 1000                           │   │
│  │  Custom:     DetectionLatencyP99 > 100ms                            │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Capacity Planning

| Workload | Tasks | vCPU | Memory | Throughput |
|----------|-------|------|--------|------------|
| Small (< 50 users) | 2 | 2 | 4 GB | 500 RPS |
| Medium (< 200 users) | 4 | 4 | 8 GB | 2000 RPS |
| Large (< 500 users) | 8 | 8 | 16 GB | 4000 RPS |
| Enterprise (1000+ users) | 16+ | 16+ | 32+ GB | 8000+ RPS |

---

## Technology Stack

### Application Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| Runtime | Python 3.11 | Application runtime |
| Framework | FastAPI | Async web framework |
| NLP | Microsoft Presidio | PII detection |
| AI Router | LiteLLM | Multi-provider routing |
| Dashboard | Streamlit | Monitoring UI |
| Container | Docker | Packaging |

### AWS Services Used

| Service | Purpose | Tier |
|---------|---------|------|
| ECS Fargate | Compute | Required |
| ECR | Container registry | Required |
| ALB | Load balancing | Required |
| Secrets Manager | Secrets storage | Required |
| CloudWatch | Logging/Monitoring | Required |
| KMS | Encryption | Required |
| VPC | Networking | Required |
| Bedrock | AI backend (optional) | Optional |
| WAF | Web security | Recommended |
| Route 53 | DNS | Optional |

---

## Deployment Architecture

### CI/CD Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CI/CD PIPELINE                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐      │
│  │  Code   │──▶│  Build  │──▶│  Test   │──▶│  Scan   │──▶│  Push   │      │
│  │  Push   │   │         │   │         │   │         │   │  (ECR)  │      │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘      │
│       │                                                        │            │
│       │                                                        ▼            │
│       │            ┌─────────────────────────────────────────────────┐     │
│       │            │                  DEPLOYMENT                      │     │
│       │            │                                                  │     │
│       │            │  ┌─────────┐   ┌─────────┐   ┌─────────┐       │     │
│       │            │  │  Dev    │──▶│ Staging │──▶│  Prod   │       │     │
│       │            │  │  (Auto) │   │ (Auto)  │   │ (Manual)│       │     │
│       │            │  └─────────┘   └─────────┘   └─────────┘       │     │
│       │            │                                                  │     │
│       │            │  Rolling deployment with health checks           │     │
│       │            │  Automatic rollback on failure                   │     │
│       │            └─────────────────────────────────────────────────┘     │
│       │                                                                     │
│       └─────────────────────────────────────────────────────────────────────│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Reference Architecture Diagrams

All diagrams are available in:
- `docs/aws/architecture/diagrams/` (source files)
- Draw.io / Lucidchart format
- PNG exports for documentation

### Diagram Index

1. `high-level-architecture.png` - System overview
2. `aws-infrastructure.png` - AWS services layout
3. `network-architecture.png` - VPC and networking
4. `data-flow.png` - Request processing flow
5. `scaling-architecture.png` - Auto-scaling setup
6. `security-architecture.png` - Security layers
7. `disaster-recovery.png` - DR configuration
