#!/usr/bin/env node
/**
 * Email Blog Post Report
 * 
 * Sends an email report when a blog post is shared on LinkedIn/Twitter.
 * Subject format: [Blog Post Report] <Blog Title>
 * 
 * Designed to work with Thunderbird mail rules:
 *   - Filter: Subject contains "[Blog Post Report]"
 *   - Action: Move to folder "Marketing/Blog Posts"
 * 
 * Usage:
 *   node scripts/email-blog-report.js --slug <blog-slug>
 *   node scripts/email-blog-report.js --title "Blog Title" --linkedin "content" --twitter "content" --url "https://..."
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.resolve(__dirname, '..');
const TO_EMAIL = 'rick@deployzeroshare.com';
const FROM_EMAIL = 'no-reply@deployzeroshare.com';
const REGION = 'us-east-1';

const POSTS_FILE = path.join(ROOT, 'tools/linkedin/content/posts.json');
const TWITTER_POSTED_FILE = path.join(ROOT, 'tools/twitter/posted.json');

function sendEmail(subject, body) {
  const emailJson = {
    Source: FROM_EMAIL,
    Destination: { ToAddresses: [TO_EMAIL] },
    Message: {
      Subject: { Data: subject, Charset: 'UTF-8' },
      Body: {
        Text: { Data: body, Charset: 'UTF-8' },
      },
    },
  };

  const jsonFile = path.join(ROOT, '.email-temp.json');
  fs.writeFileSync(jsonFile, JSON.stringify(emailJson), 'utf-8');

  try {
    execSync(`aws ses send-email --cli-input-json file://${jsonFile} --region ${REGION}`, {
      stdio: 'pipe',
      encoding: 'utf-8',
    });
    fs.unlinkSync(jsonFile);
    console.log(`‚úÖ Blog post report emailed to ${TO_EMAIL}`);
    return true;
  } catch (e) {
    if (fs.existsSync(jsonFile)) fs.unlinkSync(jsonFile);
    console.error(`‚ùå Failed to send email: ${e.message}`);
    return false;
  }
}

function getLinkedInPost(slug) {
  if (!fs.existsSync(POSTS_FILE)) return null;
  const posts = JSON.parse(fs.readFileSync(POSTS_FILE, 'utf-8'));
  return posts.find(p => p.blogSlug === slug && p.status === 'published');
}

function getTwitterPost(linkedinId) {
  if (!fs.existsSync(TWITTER_POSTED_FILE)) return null;
  try {
    const posted = JSON.parse(fs.readFileSync(TWITTER_POSTED_FILE, 'utf-8'));
    return posted.find(p => p.linkedinId === linkedinId);
  } catch {
    return null;
  }
}

function sendBlogReport({ title, slug, blogUrl, linkedinContent, linkedinUrl, twitterContent, twitterUrl }) {
  // Subject format that Thunderbird can filter on
  const subject = `[Blog Post Report] ${title}`;
  
  const parts = [];
  parts.push('‚ïê'.repeat(60));
  parts.push('ZEROSHARE BLOG POST REPORT');
  parts.push('‚ïê'.repeat(60));
  parts.push('');
  parts.push(`üì∞ BLOG POST: ${title}`);
  parts.push(`üîó URL: ${blogUrl}`);
  parts.push(`üìÖ Date: ${new Date().toISOString()}`);
  parts.push('');
  
  // LinkedIn Section
  parts.push('‚îÄ'.repeat(60));
  parts.push('üìò LINKEDIN POST');
  parts.push('‚îÄ'.repeat(60));
  if (linkedinContent) {
    parts.push('');
    parts.push(linkedinContent);
    parts.push('');
    if (linkedinUrl) {
      parts.push(`üîó View on LinkedIn: ${linkedinUrl}`);
    }
  } else {
    parts.push('(Not yet posted to LinkedIn)');
  }
  parts.push('');
  
  // Twitter Section
  parts.push('‚îÄ'.repeat(60));
  parts.push('üê¶ TWITTER/X POST');
  parts.push('‚îÄ'.repeat(60));
  if (twitterContent) {
    parts.push('');
    parts.push(twitterContent);
    parts.push('');
    if (twitterUrl) {
      parts.push(`üîó View on Twitter: ${twitterUrl}`);
    }
  } else {
    parts.push('(Not yet cross-posted to Twitter)');
  }
  parts.push('');
  
  parts.push('‚ïê'.repeat(60));
  parts.push('This email was auto-generated by ZeroShare marketing automation.');
  parts.push('Filter rule: Subject contains "[Blog Post Report]" ‚Üí Move to Marketing/Blog Posts');
  parts.push('‚ïê'.repeat(60));
  
  return sendEmail(subject, parts.join('\n'));
}

// Parse command line arguments
const args = process.argv.slice(2);

function getArg(name) {
  const idx = args.findIndex(a => a === `--${name}`);
  return idx !== -1 && args[idx + 1] ? args[idx + 1] : null;
}

const slug = getArg('slug');
const title = getArg('title');
const linkedinContent = getArg('linkedin');
const twitterContent = getArg('twitter');
const blogUrl = getArg('url');
const linkedinUrl = getArg('linkedin-url');
const twitterUrl = getArg('twitter-url');

if (slug) {
  // Look up from posts.json
  const linkedinPost = getLinkedInPost(slug);
  if (!linkedinPost) {
    console.error(`‚ùå No published LinkedIn post found for slug: ${slug}`);
    process.exit(1);
  }
  
  const twitterPost = getTwitterPost(linkedinPost.linkedinPostId);
  
  sendBlogReport({
    title: linkedinPost.blogTitle || slug,
    slug,
    blogUrl: `https://deployzeroshare.com/blog/${slug}`,
    linkedinContent: linkedinPost.content,
    linkedinUrl: linkedinPost.linkedinPostId ? `https://www.linkedin.com/feed/update/${linkedinPost.linkedinPostId}` : null,
    twitterContent: twitterPost?.tweet || null,
    twitterUrl: twitterPost?.tweetId ? `https://twitter.com/DeployZeroShare/status/${twitterPost.tweetId}` : null,
  });
  
} else if (title && (linkedinContent || twitterContent)) {
  // Direct input
  sendBlogReport({
    title,
    slug: title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
    blogUrl: blogUrl || 'https://deployzeroshare.com/blog',
    linkedinContent,
    linkedinUrl,
    twitterContent,
    twitterUrl,
  });
  
} else {
  console.log('Usage:');
  console.log('  node scripts/email-blog-report.js --slug <blog-slug>');
  console.log('  node scripts/email-blog-report.js --title "Title" --linkedin "content" --twitter "content" --url "https://..."');
  console.log('');
  console.log('Options:');
  console.log('  --slug          Blog post slug (looks up from posts.json)');
  console.log('  --title         Blog post title');
  console.log('  --linkedin      LinkedIn post content');
  console.log('  --twitter       Twitter post content');
  console.log('  --url           Blog post URL');
  console.log('  --linkedin-url  LinkedIn post URL');
  console.log('  --twitter-url   Twitter post URL');
  console.log('');
  console.log('Thunderbird Filter Rule:');
  console.log('  Subject contains: [Blog Post Report]');
  console.log('  Action: Move to folder "Marketing/Blog Posts"');
}
