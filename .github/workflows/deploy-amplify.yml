name: Verify Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Wait for Amplify auto-deployment
        run: |
          echo "Waiting 90 seconds for Amplify auto-deployment to complete..."
          echo "Amplify is connected to GitHub and deploys automatically on push"
          sleep 90
      
      - name: Run smoke tests against deployed site
        id: smoke-tests
        env:
          BASE_URL: https://deployzeroshare.com
        run: npm run test:smoke
      
      - name: Run link validation tests
        id: link-tests
        env:
          BASE_URL: https://deployzeroshare.com
        run: npm run test:links
      
      # Skip form tests in CI to avoid sending real API requests/emails
      # Form tests should be run manually when needed
      - name: Skip form tests
        run: echo "Form tests skipped in CI to avoid email spam"
      
      - name: Run full deployment verification
        id: deployment-tests
        env:
          BASE_URL: https://deployzeroshare.com
        run: npm run test:deployed
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      
      # Email notifications disabled to reduce spam
      # Results are available in GitHub Actions UI
      # To enable failure notifications, configure EMAIL_* secrets
      - name: Report status
        if: always()
        run: |
          echo "## Deployment Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed - check logs above" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
